<!DOCTYPE html>
<html lang="en">
<head>
    <!-- [Keep all your existing head content] -->
    <style>
        /* [Keep all your existing CSS] */
        
        /* Add loading indicator */
        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }
        .spinner {
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--accent);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- [Keep all your existing HTML structure] -->

    <!-- Add loading overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner"></div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBlAtG3aDSqN7iLX-HtoMZopsPT4LsMni0",
            authDomain: "elitefxreturn.firebaseapp.com",
            projectId: "elitefxreturn",
            storageBucket: "elitefxreturn.firebasestorage.app",
            messagingSenderId: "333913364691",
            appId: "1:333913364691:web:82566d278552b6cdec1c26"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const loadingOverlay = document.getElementById('loadingOverlay');

        // Password visibility toggle
        document.getElementById('togglePassword').addEventListener('click', function() {
            const passwordInput = document.getElementById('password');
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            this.classList.toggle('fa-eye-slash');
        });

        // Login Form Handler
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorElement = document.getElementById('errorMessage');
            const successElement = document.getElementById('successMessage');
            const submitBtn = document.querySelector('.btn-submit');
            
            // Clear messages and show loading
            errorElement.style.display = 'none';
            successElement.style.display = 'none';
            loadingOverlay.style.display = 'flex';
            
            try {
                // Firebase login
                const userCredential = await auth.signInWithEmailAndPassword(email, password);
                
                // Wait for auth state to update
                await new Promise(resolve => {
                    const unsubscribe = auth.onAuthStateChanged(user => {
                        unsubscribe();
                        resolve();
                    });
                });

                // Check verification status directly from user object
                if (userCredential.user.emailVerified) {
                    window.location.href = 'dashboard.html';
                } else {
                    await auth.signOut();
                    showError('Please verify your email first. Check your inbox or <a href="#" id="resendVerification">resend verification email</a>.');
                    
                    // Add resend verification handler
                    document.getElementById('resendVerification').addEventListener('click', async (e) => {
                        e.preventDefault();
                        try {
                            await userCredential.user.sendEmailVerification();
                            showSuccess('Verification email resent!');
                        } catch (error) {
                            showError('Error resending verification: ' + error.message);
                        }
                    });
                }
                
            } catch (error) {
                console.error("Login error:", error);
                let errorMessage = 'Login failed. Please try again.';
                
                switch(error.code) {
                    case 'auth/user-not-found':
                        errorMessage = 'No account found with this email.';
                        break;
                    case 'auth/wrong-password':
                        errorMessage = 'Incorrect password.';
                        break;
                    case 'auth/too-many-requests':
                        errorMessage = 'Account temporarily locked. Try again later or reset password.';
                        break;
                    case 'auth/user-disabled':
                        errorMessage = 'This account has been disabled.';
                        break;
                }
                
                showError(errorMessage);
            } finally {
                loadingOverlay.style.display = 'none';
                submitBtn.disabled = false;
                submitBtn.textContent = 'Login';
            }
        });

        // Password Reset Handler
        document.getElementById('forgotPasswordLink').addEventListener('click', async (e) => {
            e.preventDefault();
            const email = document.getElementById('email').value || prompt('Enter your email:');
            
            if (email) {
                try {
                    await auth.sendPasswordResetEmail(email);
                    showSuccess('Password reset email sent to ' + email);
                } catch (error) {
                    showError('Error: ' + error.message);
                }
            }
        });

        // Helper functions
        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.innerHTML = message;
            errorElement.style.display = 'block';
            errorElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
        
        function showSuccess(message) {
            const successElement = document.getElementById('successMessage');
            successElement.textContent = message;
            successElement.style.display = 'block';
            successElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        // Check initial auth state (less aggressive)
        auth.onAuthStateChanged((user) => {
            if (user && user.emailVerified && window.location.pathname.endsWith('login.html')) {
                // Small delay to allow form submission to complete
                setTimeout(() => {
                    window.location.href = 'dashboard.html';
                }, 500);
            }
        });
    </script>
</body>
</html>
